

require 'rspec'

RSpec.describe 'Cryptographic weakness in failure rate calculation' do
  it 'should not allow attackers to predict failure injection via Random seeding' do
    source_path = File.join(Dir.pwd, 'ext/failure_rate.rb')
    source_code = File.read(source_path)
    
    uses_random_rand = source_code.match?(/Random\.rand/)
    uses_secure_random = source_code.match?(/SecureRandom/)
    
    if uses_random_rand
      ENV['FAILURE_RATE'] = '0.5'
      threshold = 0.5
      
      sequence_a = []
      Random.srand(99999)
      50.times { sequence_a << Random.rand(1.0) }
      
      sequence_b = []
      Random.srand(99999)
      50.times { sequence_b << Random.rand(1.0) }
      
      identical_sequences = (sequence_a == sequence_b)
      
      expect(uses_secure_random).to be(true),
        "INSECURE: Code uses Random.rand which is predictable. " \
        "Attacker can predict failure injection by seeding PRNG. " \
        "Sequences with same seed are identical: #{identical_sequences}. " \
        "Should use SecureRandom for security-sensitive operations."
    end
  ensure
    ENV.delete('FAILURE_RATE')
  end
end